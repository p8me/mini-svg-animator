<!DOCTYPE html>

<!-- <html lang="en" xmlns="http://www.w3.org/1999/xhtml"> -->
<html lang="en">

<head>
    <title>Morph-Svg Demo</title>
    <link rel="icon" href="svg/snail-normal.opt.svg" type="image/svg+xml">
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <h3>This is demo of Morph-Svg. Visit <a href="https://github.com/p8me/morph-svg">morph-svg on github</a> for the
        source code.</h3>
    <svg id="snail" viewBox="0 0 48 40" width="48mm" height="48mm"></svg>
    <br>
    <button class="happy">I love snails!</button>
    <br><br>
    <textarea id="logArea" readonly></textarea>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script type="text/javascript" src="morph-svg.js"></script>

    <script>
        states = ["normal", "happy", "scared", "upset"];
        stateToSvg = (state) => "svg/snail-" + state + ".opt.svg";
        svgFiles = []
        for (s of states) svgFiles.push(stateToSvg(s));

        svgElements = ["shell", "foot", "ltent", "leye", "rtent", "reye"];

        let logArea = document.getElementById("logArea");
        function consLog(msg) {
            logArea.value += msg + "\n";
            logArea.scrollTop = logArea.scrollHeight;
            // console.log(Date.now() - start + ": " + msg);
        }

        morphSnail = new MorphSvg(document.getElementById('snail'), states, svgFiles, svgElements, undefined, undefined, undefined, consLog);

        var shouldFollowMouse = true;

        $(document).ready(function () {
            $(".happy").hover(
                function () {
                    $("#snail").addClass("happy-snail");
                    morphSnail.morph("happy", 1200);
                    shouldFollowMouse = false;
                },
                function () {
                    $("#snail").removeClass("happy-snail");
                    morphSnail.morph("normal", 3000);
                    shouldFollowMouse = true;
                });
            $("#snail").hover(function () { shouldFollowMouse = false; }, function () { shouldFollowMouse = true; });
        });

        var snail = document.getElementById("snail");
        snail.onmouseover = () => morphSnail.morph("scared", 1000);
        snail.onmouseout = () => morphSnail.morph("normal", 3000);

        setTimeout(() => {
            let $lpup = $("#lpup");
            let $rpup = $("#rpup");
            let $leye = $("#leye");
            let $reye = $("#reye");

            function getPupilLocation($eye, event) {
                let eyeX = $eye.offset().left + $eye.width() / 2;
                let eyeY = $eye.offset().top + $eye.height() / 2;
                let dx = event.pageX - eyeX;
                let dy = event.pageY - eyeY;
                let norm = Math.sqrt(dx * dx + dy * dy);
                return { x: dx / norm, y: dy / norm }
            }

            $("html").mousemove((event) => {
                if (shouldFollowMouse)
                    rpupCenter = getPupilLocation($reye, event);
                else
                    rpupCenter = { x: 0, y: 0 };
                rpup.setAttribute("transform", `translate(${rpupCenter.x}, ${rpupCenter.y})`)
                lpup.setAttribute("transform", `translate(${rpupCenter.x}, ${rpupCenter.y})`)
            });

        }, 1000);

    </script>

</body>

</html>