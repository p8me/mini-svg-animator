<!DOCTYPE html>

<!-- <html lang="en" xmlns="http://www.w3.org/1999/xhtml"> -->
<html lang="en">

<head>
    <title>Morph-Svg Demo</title>
    <link rel="icon" href="svg/snail-normal.opt.svg" type="image/svg+xml">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="animejs, morph, svg, batch, animation, smooth, interruption">
    <meta name="description"
        content="A vanillajs library for smooth transition of SVG animations and animating batch of svg elements.">
    <meta name="author" content="p8me">
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <h3>This is a demo of Morph-Svg. Visit <a href="https://github.com/p8me/morph-svg">morph-svg on github</a> for the
        source code.</h3>
    <svg id="snail" viewBox="0 0 48 40" width="48mm" height="48mm"></svg>
    <br>
    <div class="buttons">
        <button class="happy">We love snails!</button>
        <button class="sad">We don't care about snails!</button>
    </div>
    <br><br>
    <textarea id="logArea" readonly></textarea>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script type="text/javascript" src="morph-svg.js"></script>

    <script>
        states = ["normal", "happy", "scared", "sad"];
        stateToSvg = state => "svg/snail-" + state + ".opt.svg";
        svgFiles = []
        for (s of states) svgFiles.push(stateToSvg(s));

        svgElements = ["shell", "foot", "ltent", "leye", "rtent", "reye"];

        elemById = (id) => document.getElementById(id);

        let logArea = elemById("logArea");
        function consLog(msg) {
            logArea.value += msg + "\n";
            logArea.scrollTop = logArea.scrollHeight;
            // console.log(Date.now() - start + ": " + msg);
        }

        morphSnail = new MorphSvg(elemById('snail'), states, svgFiles, svgElements);
        smoothSnailAnime = new SmoothAnime(undefined, undefined, consLog);
        smoothMorphSnail = (state, duration) => { smoothSnailAnime.morph(morphSnail.anims(state, duration)); }

        var eyesFollowMouse = true;
        pupLoc = [0, 0];

        var snail = elemById("snail");
        snail.onmouseover = () => smoothMorphSnail("scared", 1000);
        snail.onmouseout = () => smoothMorphSnail("normal", 3000);

        function classOnMouseHover(selector, classAddRemove /*to add on hover and to remove on out*/, onOver, onOut) {
            document.querySelectorAll(selector).forEach(e => {
                e.onmouseover = () => {
                    snail.classList.add(classAddRemove);
                    onOver();
                }
                e.onmouseout = () => {
                    snail.classList.remove(classAddRemove);
                    onOut();
                }
            }
            );
        }

        classOnMouseHover(".happy", "happy-snail", () => {
            smoothMorphSnail("happy", 1200);
            eyesFollowMouse = false;
            pupLoc = [0, 0];
        }, () => {
            smoothMorphSnail("normal", 3000);
            eyesFollowMouse = true;
        });

        classOnMouseHover(".sad", "sad-snail", () => {
            smoothMorphSnail("sad", 3000);
            eyesFollowMouse = false;
            pupLoc = [1, 1];
        }, () => {
            smoothMorphSnail("normal", 3000);
            eyesFollowMouse = true;
        });

        // Eyes
        smoothEyesAnime = new SmoothAnime();
        // smoothEyesAnime = new SmoothAnime(100, 0, consLog);
        setTimeout(() => {
            let lpup = elemById("lpup");
            let rpup = elemById("rpup");
            let pupRef = elemById("reye");

            smoothMorphEyes = (lpup, rpup, loc) => {
                anim = pup => ({
                    targets: pup,
                    transform: `translate(${loc[0]}, ${loc[1]})`,
                    duration: 500,
                    easing: 'easeInOutQuad'
                });
                smoothEyesAnime.morph([anim(lpup), anim(rpup)]);
            };
            let mousePos = [0, 0];
            document.onmousemove = event => {
                mousePos = [event.pageX, event.pageY];
            };
            let rpupLocLast = [0, 0];
            setInterval(() => {
                if (eyesFollowMouse) {
                    let ref = pupRef.getBoundingClientRect()
                    let dx = mousePos[0] - (ref.left + ref.width / 2);
                    let dy = mousePos[1] - (ref.top + ref.height / 2);
                    let norm = Math.sqrt(dx * dx + dy * dy);
                    pupLoc = [dx / norm, dy / norm];
                }

                if (Math.abs(rpupLocLast[0] - pupLoc[0]) + Math.abs(rpupLocLast[1] - pupLoc[1]) > 0.1) {
                    smoothMorphEyes(lpup, rpup, pupLoc);
                    rpupLocLast = pupLoc;
                }
            }, 500);


        }, 1000);

    </script>

</body>

</html>