<!DOCTYPE html>

<!-- <html lang="en" xmlns="http://www.w3.org/1999/xhtml"> -->
<html lang="en">

<head>
    <title>particle matters</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <h1 id=happy>happy</h1>

    <svg id="snail" viewBox="5 5 40 35">
        <path id="shell" />
        <path id="antL" />
        <path id="antR" />
        <circle id="eyeL" r="3" />
        <circle id="eyeR" r="3" />
        <path id="foot" />
    </svg>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>

    <script>
        var shell = document.getElementById("shell");

        var snail = document.getElementById("snail");
        var antL = document.getElementById("antL");
        var antR = document.getElementById("antR");
        var eyeL = document.getElementById("eyeL");
        var eyeR = document.getElementById("eyeR");
        var foot = document.getElementById("foot");

        var happy = document.getElementById("happy");

        var paths = {
            normal: {
                shell: "m 12.5,26.8 c -1.5,0.1 -2.1,-1.7 -1.8,-2.9 0.6,-2.2 3.3,-3 5.2,-2.2 2.9,1.1 3.9,4.7 2.6,7.4 -1.6,3.6 -6.1,4.7 -9.55,3 -4.25,-2.1 -5.57,-7.6 -3.4,-11.7 2.61,-4.9 8.95,-6.4 13.75,-3.8 4.9,2.7 6.9,8.8 5,13.9",
                antL: "m 29.9,32.2 c -0.1,-3.1 0.3,-6.2 1.1,-9.2 0.4,-1.8 1,-3.7 1.8,-5.5",
                antR: "m 34.7,32.8 c -0.2,-3.2 0.4,-6.5 1.8,-9.5 0.9,-2.1 2.1,-4 3.7,-5.7",
                foot: "m 40.2,37.3 c -4.1,-0.3 -8.1,-0.5 -12.1,-0.5 -4.1,0 -8.2,0.2 -12.2,0.5 h -10.92",
                eyeL: { x: "34.4", y: "13.2" },
                eyeR: { x: "43.7", y: "14.3" }

            },
            scared: {
                shell: "m 13,30.2 c -0.2,0.1 -0.4,-0.2 -0.4,-0.5 -0.1,-0.7 0.8,-1 1.4,-0.9 1.3,0.1 1.9,1.7 1.6,2.9 -0.6,2.2 -3.1,3.1 -5.1,2.4 -3.22,-1 -4.39,-4.9 -3.27,-7.8 1.66,-4.4 6.97,-6 11.17,-4.3 4.5,1.9 6.9,6.9 6.3,11.6",
                antL: "m 28.9,34.8 c 0.2,-1.3 0.3,-2.5 0.3,-3.8 0,-1.1 -0.1,-2.1 -0.3,-3.2",
                antR: "m 33.7,35.4 c 0.1,-1.3 0.2,-2.6 0.5,-3.9 0.2,-1.1 0.5,-2.1 0.9,-3.1",
                foot: "m 37.1,37 c -4,-0.2 -8,-0.2 -12,-0.1 -5,0.4 -10.1,0.2 -15.12,0.1 h -4.12",
                eyeL: { x: "28.5", y: "22.5" },
                eyeR: { x: "37.4", y: "23.6" }
            },
            happy: {
                shell: "m 12.3,28.2 c -2.2,-0.1 -2.95,-2.7 -2.34,-4.4 1.04,-2.8 4.44,-3.8 6.94,-2.6 3.5,1.6 4.5,5.9 2.9,9.1 -2.1,4 -7.2,5.2 -11.05,3.2 -4.54,-2.5 -5.91,-8.4 -3.43,-12.8 2.85,-5.1 9.48,-6.6 14.48,-3.7 4.8,2.8 6.8,8.9 4.8,14.1",
                antL: "m 30.2,33.9 c 0.7,-3 1.1,-6.1 1.1,-9.2 0,-2.4 -0.1,-4.8 -0.5,-7.2",
                antR: "m 35,34.5 c 0.3,-3.2 0.9,-6.4 1.8,-9.5 0.7,-2.5 1.6,-5 2.7,-7.3",
                foot: "m 40.5,37.5 c -4,-0.3 -8.1,-0.5 -12.1,-0.5 -4.1,0 -8.1,0.2 -12.2,0.5 h -10.87",
                eyeL: { x: "29.8", y: "12.2" },
                eyeR: { x: "42.2", y: "13.0" }
            }
        }

        shell.setAttribute("d", paths.normal.shell);
        antL.setAttribute("d", paths.normal.antL);
        antR.setAttribute("d", paths.normal.antR);
        foot.setAttribute("d", paths.normal.foot);
        eyeL.setAttribute("cx", paths.normal.eyeL.x); eyeL.setAttribute("cy", paths.normal.eyeL.y);
        eyeR.setAttribute("cx", paths.normal.eyeR.x); eyeR.setAttribute("cy", paths.normal.eyeR.y);

        function animate(target, path, dur) {
            return anime({
                targets: target,
                d: { value: path },
                duration: dur,
                easing: 'easeInOutQuad'
            });
        }

        function animate_center(target, center, dur) {
            return anime({
                targets: target,
                cx: center.x,
                cy: center.y,
                duration: dur,
                easing: 'easeInOutQuad'
            });
        }

        class TimeMagic {
            constructor() {
                this.accumulateTime = -1;
                this.lastTime = -1;
                this.speed = 1;
            }
            reset() {
                this.accumulateTime = -1;
                this.lastTime = -1;
                this.speed = 1;
            }
            updateTime(t) {
                if (this.accumulateTime === -1) {
                    this.accumulateTime = t;
                } else {
                    const deltaT = t - this.lastTime;
                    this.accumulateTime += deltaT * this.speed;
                }
                this.lastTime = t;
            }
            getTime() { return this.accumulateTime; }
        }

        timeManager = new TimeMagic();
        var queueIsFull = false;
        var anims = [];
        var queuedAnim;
        var slowDownAcceleration = 0.02;
        const animStopSlowingProgressThres = 15; // percent

        function animSnail(state, dur, slowDownAccel) {
            
            queuedAnim = function () {
                timeManager.reset();
                // console.log(state);
                anims[0] = animate(shell, paths[state].shell, dur);
                anims[1] = animate(antL, paths[state].antL, dur);
                anims[2] = animate(antR, paths[state].antR, dur);
                anims[3] = animate(foot, paths[state].foot, dur);
                anims[4] = animate_center(eyeL, paths[state].eyeL, dur);
                anims[5] = animate_center(eyeR, paths[state].eyeR, dur);
                queueIsFull = false;
            }
            if (anims.length) {
                if (!queueIsFull) {
                    // console.log("queueing " + state);
                    slowDownAcceleration = slowDownAccel;
                    requestAnimationFrame(loop);
                    queueIsFull = true;
                }
            }
            else queuedAnim();
        }

        function loop(t) {
            timeManager.speed -= slowDownAcceleration;
            if (timeManager.speed < 0) timeManager.speed = 0;
            timeManager.updateTime(t);
            var slowedTime = timeManager.getTime();
            anims.forEach(an => an.tick(slowedTime));
            if (50 - Math.abs(anims[0].progress - 50) > animStopSlowingProgressThres && timeManager.speed > 0)
                requestAnimationFrame(loop);
            else {
                // console.log("slowDown finished");
                anims.forEach(an => an.pause());
                queuedAnim();
            }
        }

        snail.onmouseover = function () {
            animSnail("scared", 1000, 0.1);
        }
        snail.onmouseout = happy.onmouseout = function () {
            animSnail("normal", 3000, 0.02);
        }
        happy.onmouseover = function () {
            animSnail("happy", 1500, 0.02);
        }

    </script>

</body>

</html>